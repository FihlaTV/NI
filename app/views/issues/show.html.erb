<%- model_class = Issue -%>

<% if can? :update, @issue %>
<div class="edit-issue-buttons">
  <%= link_to t('.edit', :default => t("helpers.links.edit")),
                edit_issue_path(@issue), :class => 'btn btn-primary btn-mini' %>
  <% if can? :destroy, @issue %>
    <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
          issue_path(@issue),
          :method => 'delete',
          :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure? Becuase if you delete this Issue, it will also delete all of the Articles and any purchases of this Issue. Are you really sure?')),
          :class => 'btn btn-mini btn-danger' %>
  <% end %>
   | 
  <% if can? :create, Article %>
    <%= link_to 'New Article', new_issue_article_path(@issue), :class => 'btn btn-mini btn-success' %>
     |
    <%= link_to 'Import articles', issue_import_path(@issue), :class => 'btn btn-mini btn-warning',
                :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure? Because this will try and import all the articles from Bricolage.')) %>
  <% end %>
</div>
<% end %>

<div class="page-header issue-title">
  <h1><%= @issue.title %></h1>
  <h2>NI <%= @issue.number %> - <%= @issue.release.strftime("%B, %Y") %></h2>
</div>

<div class="row-fluid">
  <div class="span6 issue-articles-container">
      <div class="issue-article keynote">
        <%= retina_image_tag @issue.cover_url(:thumb).to_s, :class => 'issue-cover shadow', :alt => "New Internationalist magazine: #{@issue.title}", :title => "New Internationalist magazine: #{@issue.title}", :size => "141x200" %>
        <h5>The big story</h5>
        <% if @issue.articles.find_by_keynote(true) %>
          <% @issue.articles.find_by_keynote(true) do |article| %>
            <% if can? :read, article %><h4><%= link_to article.title, issue_article_path(@issue,article) %></h4><% else %><h4><%= article.title %></h4><% end %>
            <p><%= simple_format article.teaser %></p>
            <p><% if can? :read, article %>
              <%= link_to 'Read more', issue_article_path(@issue,article), :class => 'btn btn-mini' %>
            <% else %>
              <%= link_to 'Buy this issue', new_issue_purchase_path(@issue), :class => 'btn btn-mini btn-primary' %>
            <% end %>
            <% if can? :update, @article %><%= link_to 'Edit', edit_issue_article_path(@issue,article), :class => 'btn btn-primary btn-mini' %><% end %>
            <% if can? :destroy, @article %><%= link_to 'Destroy', issue_article_path(@issue,article), confirm: 'Are you sure?', method: :delete, :class => 'btn btn-mini btn-danger' %><% end %></p>
          <% end %>
        <% end %>
      </div>
      <% unless @issue.articles[1].nil? %>
        <h3>Other articles in this issue.</h3>
        <% @issue.articles.select{|a| not a.keynote}.each do |article| %>
          <div class="issue-article">
          <% if can? :read, article %>
            <% if not article.featured_image.blank? %><%= link_to retina_image_tag(article.featured_image_url(:thumb).to_s, :class => 'article-thumb', :alt => "#{strip_tags(article.featured_image_caption)}", :title => "#{strip_tags(article.featured_image_caption)}", :size => "80x80"), issue_article_path(@issue,article) %><% end %>
            <h4><%= link_to article.title, issue_article_path(@issue,article) %></h4>
          <% else %>
            <% if not article.featured_image.blank? %><%= retina_image_tag(article.featured_image_url(:thumb).to_s, :class => 'article-thumb', :alt => "#{strip_tags(article.featured_image_caption)}", :title => "#{strip_tags(article.featured_image_caption)}", :size => "80x80") %><% end %>
            <h4><%= article.title %></h4>
          <% end %>
          <p><%= simple_format article.teaser %></p>
          <p><% if can? :read, article %>
          <%= link_to 'Read more', issue_article_path(@issue,article), :class => 'btn btn-mini' %>
          <% else %>
            <%= link_to 'Buy this issue', new_issue_purchase_path(@issue), :class => 'btn btn-mini btn-primary' %>
          <% end %>
          <% if can? :update, @article %><%= link_to 'Edit', edit_issue_article_path(@issue,article), :class => 'btn btn-primary btn-mini' %><% end %>
          <% if can? :destroy, @article %><%= link_to 'Destroy', issue_article_path(@issue,article), confirm: 'Are you sure?', method: :delete, :class => 'btn btn-mini btn-danger' %><% end %></p>
          </div>
        <% end %>
      <% end %>
  </div>
  <div class="span6 editors-letter">
    <% if @issue.editors_letter != "" %>
      <h3>A note from this month's editor</h3>
      <%= retina_image_tag @issue.editors_photo_url(:thumb).to_s, :class => 'editors-photo img-polaroid', :alt => "#{@issue.editors_name}", :title => "#{@issue.editors_name}", :width => "100" %>
      <%= simple_format @issue.editors_letter %>
      <p><strong><%= @issue.editors_name %></strong> for the New Internationalist co-operative.<br /><a href="http://www.newint.org">www.newint.org</a></p>
    <% end %>
  </div>
</div>

<div class="form-actions">
  <%= link_to t('.back', :default => t("helpers.links.back")),
              issues_path, :class => 'btn' %>
  <% if can? :create, Article %>
    <%= link_to 'New Article', new_issue_article_path(@issue), :class => 'btn btn-primary' %>
  <% end %>
</div>
